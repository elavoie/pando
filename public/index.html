<html>
  <head>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
      body {
        font-family: "Helvetica Neue", helvetica, arial;
        padding: 15px;
      }

      ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      ul li {
        line-height: 1.4;
      }
    </style>

    <script>
      console.log = function (s) {
        var li = document.createElement('li');
        li.innerHTML = s;
        document.querySelector('#console').appendChild(li);
      }
    </script>
  </head>
<body>
  <div id='visualization'></div>
  <h1>device</h1>
<div class="input-group mb-3">
  <div class="input-group-prepend">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">List</button>
    <div class="dropdown-menu" id='device-list'>
    </div>
  </div>
  <input id='device-name' type="text" class="form-control" aria-label="Text input with dropdown button" onkeypress="return submit(event)">
</div>
  <h1>status</h1>
  <div id='throughput'></div>
  <p><a id='status'></a></p>
  <h1>console.log</h1>
  <ul id='console'></ul>
  <script src='simplewebsocket.min.js'></script>
  <script src='volunteer.js'></script>
  <script src='bundle.js'></script>
  <script src='config.js'></script>

  <script>
    var secure = location.origin.indexOf('https:\/\/') > -1

    var host = null
    if (secure) {
      host = location.origin.replace(/^https:\/\//, '')
    } else {
      host = location.origin.replace(/^http:\/\//, '')
    }

    var seconds = 3
    var restarting = false
    var connectTimeout = null
    var reporter = null

    function protocol () {
      if (location.hash.includes('protocol=websocket')) {
        return 'protocol=websocket'
      } else if (location.hash.includes('protocol=webrtc')) {
        return 'protocol=webrtc'
      } else {
        return ''
      }
    }

    function restart () {
      if (restarting) return
      console.log('restart()')
      document.querySelector('#status').textContent = 'Restarting' 
      restarting = true
      if (processor) processor.close()
      processor = null
      countdown(seconds, 'Connecting', start)
    }

    function countdown (seconds, actionText, cb) {
      if (seconds <= 0) {
        document.querySelector('#status').textContent = actionText;
        cb()
      } else {
        document.querySelector('#status').textContent = actionText + ' in ' + seconds + ' seconds'
        setTimeout(function () { countdown(seconds-1, actionText, cb) }, 1000)
      }
    }

    function start () {
      console.log('start()')
      var processor = null
      window.pando.config.secure = secure
      setTimeout(function () {
        if (location.hash.includes('protocol=websocket')) {
          console.log('connecting over WebSocket')
          var protocol = secure ? 'wss://' : 'ws://'
          processor = volunteer['websocket'](protocol + host + '/volunteer', bundle)
        } else if (location.hash.includes('protocol=webrtc')) {
          processor = volunteer['webrtc'](host, bundle, window.pando.config)
        } else {
          processor = volunteer['webrtc'](host, bundle, window.pando.config)
        }
        processor.on('status', function (summary) {
          document.querySelector('#status').textContent = JSON.stringify(summary, null, '    ')
          if (reporter) {
            console.log('reporting status')
            reporter.send(JSON.stringify(summary))
          }
        })
        processor.on('close', function () {
          restart()
          if (reporter) {
            console.log('reporting processor closed')
            reporter.send(JSON.stringify({ type: 'STATUS', closed: true }))
          }
        })
        processor.on('error', function (err) {
          restart()
          if (reporter) {
            console.log('reporting processor error')
            reporter.send(JSON.stringify({ type: 'STATUS', error: err }))
          }
        })
        processor.on('ready', function () {
          console.log('cleared restart timeout')
          document.querySelector('#status').textContent = 'Connected'
          clearTimeout(connectTimeout)
          restarting = false
        })

        // If connection does not succeed, keep retrying until it does
        console.log('setting restart timeout')
        connectTimeout = setTimeout(function () {
            console.log('connection timeout')
            if (reporter) {
              console.log('reporting connection timeout')
              reporter.send(JSON.stringify({ type: 'STATUS', error: 'Connection timeout, restarting' }))
            }
            restarting = false
            restart()
        }, 30 * 1000)

        window.processor = processor
      }, Math.floor(Math.random() * 1000)) // Random delay of up to 1s to avoid all nodes connecting at the same time
    }

    countdown(0, 'Connecting', start)

    if (window.pando.config.globalMonitoring) {
      var protocol = secure ? 'wss://' : 'ws://'
      var socket = SimpleWebsocket(protocol + host + '/monitoring/processor')
      socket.on('connect', function () {
        console.log('reporter connected')
        reporter = socket  
      })
    } 

    // Add default list of devices
    var deviceList = [
      'MacBook Air 2011',
      'iPhone SE',
      'MacBook Pro 2016',
      'Samsung Galaxy S6',
      'Samsung Galaxy S7',
      'OPPO F1FX 2016',
      'Lenovo P2a42 2016',
      'Huawei P10 lite 2017',
      'Wileyfox Storm 2016',
      'iPhone 7',
      'LG G6 H870 2017',
      'iPad A1822 (5th Gen) 2017',
      'Samsung A3 2016',
      'Samsung Galaxy S7',
      'iPhone 6S'
    ]
    deviceList.sort()
    deviceListMenu = document.getElementById('device-list')
    deviceList.forEach(function (name) {
      var a = document.createElement('a')
      a.className = 'dropdown-item'
      a.innerText = name
      var id = name.replace(/\s/g, '_')
      a.href = '#' + protocol() + ';device=' + id + ';'
      a.id = id
      a.onclick = function () { replaceDeviceName(name) } 
      deviceListMenu.appendChild(a)
    })
    function getDeviceName() {
      if (location.hash.includes('device=')) {
        var m = location.hash.match('device=(.*);')  
        var deviceName = document.getElementById('device-name')
        deviceName.value = m[1].replace(/_/g, ' ')
      }
    }
    function replaceDeviceName(name) {
      var deviceName = document.getElementById('device-name')
      deviceName.value = name
    }
    getDeviceName()


    function submit(event) {
      if (event.keyCode !== 13) return

      var hash = location.hash.replace(/^#*;*/, '#;')
      var deviceName = document.getElementById('device-name').value.replace(/\s/g, '_')
      if (hash.includes('device=')) {
        hash = hash.replace(/device=.*;/, 'device=' + deviceName + ';')
      } else {
        hash = hash + 'device=' + deviceName + ';'
      }
      var url =  location.protocol + '\/\/' + location.host + '\/' + hash
      location.assign(url)
    }
  </script>
  <script src="jquery.min.js"></script>
<script src="popper.min.js"></script>
<script src="bootstrap.min.js"></script>
</body>
</html>
